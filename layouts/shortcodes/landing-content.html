<!-- layouts/shortcodes/landing-content.html -->
{{ $targetTag := .Get "tag" }}
{{ $pubs := where .Site.RegularPages "Type" "publication" }}

<section class="tagged-content">

  <h2>{{ $targetTag | title }} Publications</h2>

  <ul class="publication-list">
    {{ $found := false }}

    {{ range (sort $pubs "Date" "desc") }}
      {{ $tags := split (.Params.tags | default "") "," }}
      {{ $cleaned := slice }}

      {{ range $tags }}
        {{ $cleaned = $cleaned | append (trim . "[] ") }}
      {{ end }}

      {{ if in $cleaned $targetTag }}
        {{ $found = true }}
        <li class="publication-item">
          <article>
            {{ $formattedDate := .Date.Format "2006-01-02 Monday" }}
            <span>{{ $formattedDate }}</span> -
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>

            {{ with .Params.tags }}
              {{ $raw := split . ", " }}
              {{ $filtered := slice }}

              {{ range $raw }}
                {{ $t := trim . "[] " }}
                {{ if ne $t $targetTag }}
                  {{ $filtered = $filtered | append $t }}
                {{ end }}
              {{ end }}

              {{ if gt (len $filtered) 0 }}
              <span class="tag-small">
                [{{ delimit $filtered ", " }}]
              </span>
              {{ end }}
            {{ end }}

            {{ with .Params.authors }}
              <div class="authors">
                {{ delimit . ", " " and " }}
              </div>
            {{ end }}
          </article>
        </li>
      {{ end }}
    {{ end }}

    {{ if not $found }}
      <li>No publications found with tag "{{ $targetTag }}"</li>
    {{ end }}

  </ul>

</section>
